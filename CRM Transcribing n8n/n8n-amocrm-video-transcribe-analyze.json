{
  "name": "amoCRM: –≤–∏–¥–µ–æ ‚Üí —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏ –∞–Ω–∞–ª–∏–∑",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "amocrm-video",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook amoCRM",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "amocrm-video-analyzer"
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–º —Ç–µ–ª–æ –≤–µ–±—Ö—É–∫–∞ amoCRM (—Å–æ–±—ã—Ç–∏–µ attachment_note_added)\n// –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://www.amocrm.ru/developers/content/crm_platform/webhooks-api\nconst body = $input.first().json.body || $input.first().json;\n\nlet entityType = body.entity_type || 'lead';\nlet entityId = body.entity_id;\nlet noteId = null;\nlet fileUuid = null;\n\n// –ò–∑ —Å–æ–±—ã—Ç–∏—è value_after —Å–æ–¥–µ—Ä–∂–∏—Ç note.id\nif (body.value_after && Array.isArray(body.value_after) && body.value_after[0]) {\n  noteId = body.value_after[0].note?.id;\n}\n\n// –ò–Ω–æ–≥–¥–∞ file_uuid —É–∂–µ –≤ —Ç–µ–ª–µ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–µ–±—Ö—É–∫–∞)\nif (body.params?.file_uuid) {\n  fileUuid = body.params.file_uuid;\n}\n\nif (!entityId || !noteId) {\n  throw new Error('–ù–µ—Ç entity_id –∏–ª–∏ note_id –≤ —Ç–µ–ª–µ –≤–µ–±—Ö—É–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞ amoCRM.');\n}\n\nreturn [{ json: { entityType, entityId, noteId, fileUuid } }];"
      },
      "id": "parse-webhook",
      "name": "–ü–∞—Ä—Å–∏–Ω–≥ –≤–µ–±—Ö—É–∫–∞",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://{{ $env.AMOCRM_SUBDOMAIN || 'your-subdomain' }}.amocrm.ru/api/v4/leads/{{ $('–ü–∞—Ä—Å–∏–Ω–≥ –≤–µ–±—Ö—É–∫–∞').first().json.entityId }}/notes/{{ $('–ü–∞—Ä—Å–∏–Ω–≥ –≤–µ–±—Ö—É–∫–∞').first().json.noteId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "get-note",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ (note)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 300],
      "credentials": {
        "httpHeaderAuth": { "id": "AMOCRM_OAUTH", "name": "amoCRM OAuth" }
      },
      "notes": "–ù—É–∂–µ–Ω Header: Authorization = Bearer <access_token>. –¢–æ–∫–µ–Ω ‚Äî OAuth2 amoCRM (—Å–º. README)."
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://drive-b.{{ $env.AMOCRM_SUBDOMAIN || 'your-subdomain' }}.amocrm.ru/v1.0/files/{{ $json.params?.file_uuid }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "get-file-info",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ –æ —Ñ–∞–π–ª–µ (Files API)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 300],
      "credentials": {
        "httpHeaderAuth": { "id": "AMOCRM_OAUTH", "name": "amoCRM OAuth" }
      },
      "notes": "–¢—Ä–µ–±—É–µ—Ç—Å—è scope '–î–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º'. –û—Ç–≤–µ—Ç: _embedded.files[0]._links.download.href"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "download-url",
              "name": "downloadUrl",
              "value": "={{ $json._embedded?.files?.[0]?._links?.download?.href || $json._links?.download?.href }}",
              "type": "string"
            },
            {
              "id": "entity-id",
              "name": "entityId",
              "value": "={{ $('–ü–∞—Ä—Å–∏–Ω–≥ –≤–µ–±—Ö—É–∫–∞').first().json.entityId }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "set-download-url",
      "name": "–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.downloadUrl }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "download-file",
      "name": "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª (–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 300],
      "notes": "–î–ª—è drive amoCRM –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Ç–æ—Ç –∂–µ Authorization header (OAuth). –ï—Å–ª–∏ 401 ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤—Ä—É—á–Ω—É—é."
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "data",
        "options": {
          "language": "ru"
        }
      },
      "id": "openai-transcribe",
      "name": "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (OpenAI Whisper)",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1.2,
      "position": [1560, 300],
      "credentials": {
        "openAiApi": { "id": "OPENAI_API", "name": "OpenAI API" }
      }
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "messages": {
          "values": [
            {
              "content": "=–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞—É–¥–∏—Ç—É –ø—Ä–æ–¥–∞–∂ (SPIN, Sandler). –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –∑–≤–æ–Ω–∫–∞.\n\n–ü—Ä–∞–≤–∏–ª–∞:\n- –û–ø—Ä–µ–¥–µ–ª–∏ —Ä–æ–ª–∏: –ú–µ–Ω–µ–¥–∂–µ—Ä vs –ö–ª–∏–µ–Ω—Ç.\n- –û—Ü–µ–Ω–∏ —ç—Ç–∞–ø: —Ö–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫, –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è, –¥–æ–∂–∏–º.\n- –ü—Ä–æ–≤–µ—Ä—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ ‚Üí –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è ‚Üí –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è ‚Üí —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.\n- –£–∫–∞–∂–∏ –æ—à–∏–±–∫–∏ –∏ –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã.\n\n–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:\n{{ $json.text }}"
            }
          ]
        },
        "options": {
          "responseFormat": {
            "type": "json_schema",
            "jsonSchema": {
              "name": "call_analysis",
              "strict": true,
              "schema": "{\"type\":\"object\",\"properties\":{\"summary\":{\"type\":\"string\",\"description\":\"–ö—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏ (2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\"},\"manager_score\":{\"type\":\"string\",\"description\":\"–û—Ü–µ–Ω–∫–∞ 0-100\"},\"outcome\":{\"type\":\"string\",\"description\":\"–£—Å–ø–µ—Ö/–û—Ç–∫–∞–∑/–î—É–º–∞–µ—Ç\"},\"good_points\":{\"type\":\"string\"},\"next_step\":{\"type\":\"string\"},\"advice\":{\"type\":\"string\"}},\"required\":[\"summary\",\"manager_score\",\"outcome\",\"good_points\",\"next_step\",\"advice\"]}"
            }
          }
        }
      },
      "id": "openai-analyze",
      "name": "–ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–∞ (GPT)",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1.2,
      "position": [1780, 300],
      "credentials": {
        "openAiApi": { "id": "OPENAI_API", "name": "OpenAI API" }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "note-text",
              "name": "noteText",
              "value": "=üìû –†–∞–∑–±–æ—Ä –∑–≤–æ–Ω–∫–∞\n\nüìù –ö—Ä–∞—Ç–∫–æ: {{ $json.summary }}\n\nüìä –û—Ü–µ–Ω–∫–∞: {{ $json.manager_score }}/100\n–í–µ—Ä–¥–∏–∫—Ç: {{ $json.outcome }}\n\nüëç –ü–ª—é—Å—ã: {{ $json.good_points }}\n\n‚ö†Ô∏è –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: {{ $json.next_step }}\n\n‚úÖ –°–æ–≤–µ—Ç: {{ $json.advice }}",
              "type": "string"
            },
            {
              "id": "entity-id-note",
              "name": "entityId",
              "value": "={{ $('–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ').first().json.entityId }}",
              "type": "number"
            }
          ]
        }
      },
      "id": "format-note",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://{{ $env.AMOCRM_SUBDOMAIN || 'your-subdomain' }}.amocrm.ru/api/v4/leads/notes",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify([{ entity_id: $json.entityId, note_type: 'common', params: { text: $json.noteText } }]) }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "add-note-amocrm",
      "name": "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –≤ —Å–¥–µ–ª–∫—É",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2220, 300],
      "credentials": {
        "httpHeaderAuth": { "id": "AMOCRM_OAUTH", "name": "amoCRM OAuth" }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"ok\": true, \"message\": \"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞\", \"lead_id\": $('–ü–∞—Ä—Å–∏–Ω–≥ –≤–µ–±—Ö—É–∫–∞').first().json.entityId } }}"
      },
      "id": "respond-webhook",
      "name": "–û—Ç–≤–µ—Ç –≤–µ–±—Ö—É–∫—É",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2440, 300]
    },
    {
      "parameters": {
        "content": "## –ù–∞—Å—Ç—Ä–æ–π–∫–∞\n\n1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**: –∑–∞–¥–∞–π—Ç–µ `AMOCRM_SUBDOMAIN` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `alexneurosolutions`).\n\n2. **Credential amoCRM**: —Å–æ–∑–¥–∞–π—Ç–µ HTTP Header Auth:\n   - Name: `Authorization`\n   - Value: `Bearer <access_token>`\n   –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ OAuth2 amoCRM (—Å–º. README).\n\n3. **Credential OpenAI**: —É–∫–∞–∂–∏—Ç–µ API Key –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞.\n\n4. **–í–µ–±—Ö—É–∫ amoCRM**: –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ amoCRM —É–∫–∞–∂–∏—Ç–µ URL —ç—Ç–æ–≥–æ workflow (Production) –∏ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ —Å–æ–±—ã—Ç–∏–µ **attachment_note_added** (–¥–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª –∫ —Å–¥–µ–ª–∫–µ)."
      },
      "id": "sticky-note",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [200, 80]
    }
  ],
  "connections": {
    "Webhook amoCRM": { "main": [[{ "node": "–ü–∞—Ä—Å–∏–Ω–≥ –≤–µ–±—Ö—É–∫–∞", "type": "main", "index": 0 }]] },
    "–ü–∞—Ä—Å–∏–Ω–≥ –≤–µ–±—Ö—É–∫–∞": { "main": [[{ "node": "–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ (note)", "type": "main", "index": 0 }]] },
    "–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ (note)": { "main": [[{ "node": "–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ –æ —Ñ–∞–π–ª–µ (Files API)", "type": "main", "index": 0 }]] },
    "–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ –æ —Ñ–∞–π–ª–µ (Files API)": { "main": [[{ "node": "–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ", "type": "main", "index": 0 }]] },
    "–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ": { "main": [[{ "node": "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª (–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ)", "type": "main", "index": 0 }]] },
    "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª (–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ)": { "main": [[{ "node": "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (OpenAI Whisper)", "type": "main", "index": 0 }]] },
    "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (OpenAI Whisper)": { "main": [[{ "node": "–ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–∞ (GPT)", "type": "main", "index": 0 }]] },
    "–ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–∞ (GPT)": { "main": [[{ "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ", "type": "main", "index": 0 }]] },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ": { "main": [[{ "node": "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –≤ —Å–¥–µ–ª–∫—É", "type": "main", "index": 0 }]] },
    "–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –≤ —Å–¥–µ–ª–∫—É": { "main": [[{ "node": "–û—Ç–≤–µ—Ç –≤–µ–±—Ö—É–∫—É", "type": "main", "index": 0 }]] }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "meta": {
    "templateCredsSetupCompleted": false
  }
}
