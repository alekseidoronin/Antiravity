{
  "name": "MVP Call Analyzer v2 (–Ω–æ–≤—ã–π, —Å amoCRM node)",
  "nodes": [
    {
      "parameters": { "httpMethod": "POST", "path": "amocrm-call", "responseMode": "responseNode", "options": {} },
      "id": "webhook-trigger",
      "name": "Webhook amocrm",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 300],
      "webhookId": "amocrm-call-analyzer"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "loose" },
          "conditions": [
            {
              "id": "has-attachment",
              "leftValue": "={{ $json.body?.leads?.note?.[0]?.note?.attachment ?? $json.body?.leads?.note?.[0]?.note?.attachement ?? '' }}",
              "rightValue": "",
              "operator": { "type": "string", "operation": "notEmpty" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-attachment",
      "name": "–ï—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [220, 300]
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "getLeads",
        "returnAll": false,
        "limit": 1,
        "filters": {
          "id": "={{ $json.body?.leads?.note?.[0]?.note?.element_id }}"
        }
      },
      "id": "amocrm-get-lead",
      "name": "amoCRM: –ü–æ–ª—É—á–∏—Ç—å —Å–¥–µ–ª–∫—É",
      "type": "n8n-nodes-amocrm.amocrm",
      "typeVersion": 1,
      "position": [440, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://{{ $('Webhook amocrm').item.json.body?.account?.subdomain || 'alexneurosolutions' }}.amocrm.ru/api/v4/leads/{{ $json.id || $('amoCRM: –ü–æ–ª—É—á–∏—Ç—å —Å–¥–µ–ª–∫—É').item.json.id }}/links",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "amocrmOAuth2Api",
        "options": {}
      },
      "id": "http-links",
      "name": "HTTP: –ü–æ–ª—É—á–∏—Ç—å links",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, 200],
      "notes": "/links –∏ drive ‚Äî –Ω–µ—Ç –≤ —É–∑–ª–µ amoCRM, –∏—Å–ø–æ–ª—å–∑—É–µ–º HTTP —Å amocrmOAuth2Api"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://drive-b.amocrm.ru/v1.0/files/{{ $json._embedded?.notes?.[0]?.params?.file_uuid || $json.data?._embedded?.notes?.[0]?.params?.file_uuid }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "amocrmOAuth2Api",
        "options": {}
      },
      "id": "http-drive",
      "name": "HTTP: –§–∞–π–ª —Å drive",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            { "id": "file-link", "name": "file_link", "value": "={{ $json.url || $json.data?.url || $json.download_link || $json.link || $json.href }}", "type": "string" }
          ]
        },
        "options": {}
      },
      "id": "set-file-link",
      "name": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å file_link",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.assemblyai.com/v2/transcript",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"audio_url\": \"{{ $json.file_link }}\",\n  \"language_code\": \"ru\",\n  \"speaker_labels\": true\n}",
        "options": {}
      },
      "id": "assemblyai-submit",
      "name": "AssemblyAI: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1320, 200]
    },
    {
      "parameters": { "resume": "timeInterval", "amount": 20, "unit": "seconds" },
      "id": "wait-transcript",
      "name": "–ü–æ–¥–æ–∂–¥–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.assemblyai.com/v2/transcript/{{ $('AssemblyAI: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é').item.json.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "assemblyai-get",
      "name": "AssemblyAI: –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1680, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "transcript-text",
              "name": "transcript_text",
              "value": "={{ $json.text || ($json.utterances || []).map(u => (u.speaker || '') + ': ' + (u.text || '')).join('\\n') || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "set-transcript",
      "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1860, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=YOUR_GEMINI_API_KEY",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { contents: [{ parts: [{ text: `–¢—ã ‚Äî –≠–∫—Å–ø–µ—Ä—Ç –ø–æ –∞—É–¥–∏—Ç—É –ø—Ä–æ–¥–∞–∂. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –∏ –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ markdown —Å –ø–æ–ª—è–º–∏: manager_name, client_intent, summary, manager_score (0-100), outcome, good_points, bad_points, advice, next_step.\\n\\n–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:\\n${String($json.transcript_text || '')}` }] }], generationConfig: { temperature: 0.3, maxOutputTokens: 2048, responseMimeType: 'application/json' } } }}",
        "options": {}
      },
      "id": "gemini-http",
      "name": "Gemini: –ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–∞",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2040, 200]
    },
    {
      "parameters": {
        "jsCode": "const text = $input.first().json.candidates?.[0]?.content?.parts?.[0]?.text || '{}';\nlet parsed = {};\ntry {\n  parsed = typeof text === 'string' ? JSON.parse(text.replace(/```json\\n?|```/g, '').trim()) : text;\n} catch (e) {\n  parsed = { error: 'Parse error', raw: text };\n}\nreturn { json: { ...parsed } };"
      },
      "id": "parse-gemini",
      "name": "–†–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 200]
    },
    {
      "parameters": {
        "chatId": "-5203327157",
        "text": "=üìû *–†–∞–∑–±–æ—Ä –∑–≤–æ–Ω–∫–∞*\n–§–∞–π–ª: {{ $('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å file_link').item.json.file_link?.split('/').pop() || 'N/A' }}\n\nüìù *–ö—Ä–∞—Ç–∫–æ:* {{ $json.summary }}\n\nüìä –û—Ü–µ–Ω–∫–∞: {{ $json.manager_score }}/100\n\n*–í–µ—Ä–¥–∏–∫—Ç*: {{ $json.outcome }}\n\nüëç *–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –∫—Ä—É—Ç–æ:* {{ $json.good_points }}\n\n‚ö†Ô∏è *–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:* {{ $json.next_step }}\n\n‚úÖ *–°–æ–≤–µ—Ç:* {{ $json.advice }}\n\nüîó *–°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–ø–∏—Å—å* {{ $('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å file_link').item.json.file_link }}",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "telegram-send",
      "name": "Telegram: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2400, 100]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": { "__rl": true, "value": "1Ej6UtCg9vpuxS1GD0s8LnP9SGjQqV_0F", "mode": "id" },
        "sheetName": { "__rl": true, "value": "Report", "mode": "name" },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "–î–∞—Ç–∞": "={{ $now.format('DD.MM.YYYY HH:mm') }}",
            "–ú–µ–Ω–µ–¥–∂–µ—Ä": "={{ $json.manager_name }}",
            "–§–∞–π–ª": "={{ $('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å file_link').item.json.file_link?.split('/').pop() || '' }}",
            "–û—Ü–µ–Ω–∫–∞": "={{ $json.manager_score }}",
            "–ù–∞–º–µ—Ä–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞": "={{ $json.client_intent }}",
            "–í–µ—Ä–¥–∏–∫—Ç": "={{ $json.outcome }}",
            "–°–ª–µ–¥. —à–∞–≥": "={{ $json.next_step }}",
            "–°–∞–º–º–∞—Ä–∏": "={{ $json.summary }}",
            "–ü–ª—é—Å—ã": "={{ $json.good_points }}",
            "–ú–∏–Ω—É—Å—ã": "={{ $json.bad_points }}",
            "–°–æ–≤–µ—Ç": "={{ $json.advice }}",
            "–°—Å—ã–ª–∫–∞": "={{ $('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å file_link').item.json.file_link }}"
          }
        },
        "options": {}
      },
      "id": "google-sheets",
      "name": "Google Sheets: –û—Ç—á—ë—Ç",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [2400, 300]
    },
    {
      "parameters": { "mode": "combine", "combineBy": "combineByPosition", "options": {} },
      "id": "merge-branches",
      "name": "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2580, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"status\": \"ok\", \"message\": \"Call analyzed\" } }}"
      },
      "id": "respond-webhook",
      "name": "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2760, 200]
    }
  ],
  "connections": {
    "Webhook amocrm": { "main": [[{ "node": "–ï—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ?", "type": "main", "index": 0 }]] },
    "–ï—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ?": { "main": [[{ "node": "amoCRM: –ü–æ–ª—É—á–∏—Ç—å —Å–¥–µ–ª–∫—É", "type": "main", "index": 0 }], [{ "node": "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ Webhook", "type": "main", "index": 0 }]] },
    "amoCRM: –ü–æ–ª—É—á–∏—Ç—å —Å–¥–µ–ª–∫—É": { "main": [[{ "node": "HTTP: –ü–æ–ª—É—á–∏—Ç—å links", "type": "main", "index": 0 }]] },
    "HTTP: –ü–æ–ª—É—á–∏—Ç—å links": { "main": [[{ "node": "HTTP: –§–∞–π–ª —Å drive", "type": "main", "index": 0 }]] },
    "HTTP: –§–∞–π–ª —Å drive": { "main": [[{ "node": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å file_link", "type": "main", "index": 0 }]] },
    "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å file_link": { "main": [[{ "node": "AssemblyAI: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é", "type": "main", "index": 0 }]] },
    "AssemblyAI: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é": { "main": [[{ "node": "–ü–æ–¥–æ–∂–¥–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é", "type": "main", "index": 0 }]] },
    "–ü–æ–¥–æ–∂–¥–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é": { "main": [[{ "node": "AssemblyAI: –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç", "type": "main", "index": 0 }]] },
    "AssemblyAI: –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç": { "main": [[{ "node": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç", "type": "main", "index": 0 }]] },
    "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç": { "main": [[{ "node": "Gemini: –ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–∞", "type": "main", "index": 0 }]] },
    "Gemini: –ê–Ω–∞–ª–∏–∑ –∑–≤–æ–Ω–∫–∞": { "main": [[{ "node": "–†–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON", "type": "main", "index": 0 }]] },
    "–†–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON": { "main": [[{ "node": "Telegram: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É", "type": "main", "index": 0 }, { "node": "Google Sheets: –û—Ç—á—ë—Ç", "type": "main", "index": 0 }]] },
    "Telegram: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É": { "main": [[{ "node": "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å", "type": "main", "index": 0 }]] },
    "Google Sheets: –û—Ç—á—ë—Ç": { "main": [[{ "node": "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å", "type": "main", "index": 1 }]] },
    "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å": { "main": [[{ "node": "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ Webhook", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" },
  "staticData": null,
  "meta": { "templateCredsSetupCompleted": false },
  "pinData": {},
  "tags": []
}
